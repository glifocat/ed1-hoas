# ==============================================================================
# ED1 Citilab Board - ESPHome Configuration (Minimal Sample)
# ==============================================================================
#
# Project: Minimal configuration with built-in ED1 features only
# Board: ED1 Rev 2.3 (Citilab Edutec)
# Purpose: Home Assistant integration for the ED1 educational ESP32 board
#
# This sample includes ONLY built-in ED1 hardware:
#   - 1.44" TFT Display (ST7735)
#   - 6 Capacitive Touch Buttons
#   - Light Sensor
#   - Buzzer
#   - IR Receiver (38kHz)
#   - Bluetooth Proxy
#
# For external accessories (LED Matrix), see:
#   ed1-full-features.sample.yaml
#
# Usage:
#   1. Copy this file and rename (e.g., ed1-kitchen.yaml, ed1-office.yaml)
#   2. Change the 'name' and 'friendly_name' fields below
#   3. Copy secrets.sample.yaml to secrets.yaml and fill in your credentials
#   4. Run: esphome run <your-config>.yaml
#
# Documentation: https://github.com/glifocat/ed1-hoas
# License: Apache 2.0
#
# ==============================================================================

esphome:
  name: ed1-rev23-a
  friendly_name: ED1 Rev 2.3 A
  on_boot:
    priority: -100
    then:
      - rtttl.play: 'startup:d=16,o=5,b=180:c,e,g,c6'
      - delay: 3s
      - lambda: 'id(boot_complete) = true;'

esp32:
  board: esp32dev
  framework:
    type: arduino

logger:
  level: INFO

api:
  encryption:
    key: !secret api_encryption_key

ota:
  - platform: esphome
    password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  ap:
    ssid: "ED1-Rev23-Rescue"
    password: !secret fallback_ap_password

captive_portal:

globals:
  - id: boot_complete
    type: bool
    initial_value: 'false'

# ==============================================================================
# 1. HARDWARE BUSES (SPI + I2C)
# ==============================================================================
spi:
  clk_pin: GPIO18
  mosi_pin: GPIO23
  miso_pin: GPIO19

i2c:
  sda: GPIO21
  scl: GPIO22
  scan: true
  id: bus_i2c

# ==============================================================================
# 2. FONTS
# ==============================================================================
font:
  - file: "fonts/pixelmix/pixelmix.ttf"
    id: pixel_font
    size: 8
  - file: "fonts/pixelmix/pixelmix.ttf"
    id: large_font
    size: 16
  - file: "gfonts://Material+Symbols+Outlined"
    id: icons_16
    size: 16
    glyphs:
      - "\U0000e63e" # wifi
      - "\U0000e1ff" # device_thermostat
      - "\U0000e518" # light_mode
      - "\U0000e8b5" # schedule
      - "\U0000e870" # lan (network)

# ==============================================================================
# 3. TFT DISPLAY (ST7735 128x128)
# ==============================================================================
display:
  - platform: st7735
    id: internal_display
    cs_pin: GPIO5
    dc_pin: GPIO9
    reset_pin: GPIO10
    rotation: 0
    model: "INITR_GREENTAB"
    col_start: 2
    row_start: 1
    device_width: 128
    device_height: 128
    update_interval: 1s
    lambda: |-
      // Colors
      auto BLACK = Color(0, 0, 0);
      auto WHITE = Color(255, 255, 255);
      auto GREEN = Color(0, 255, 0);
      auto CYAN = Color(0, 255, 255);
      auto YELLOW = Color(255, 255, 0);
      auto ORANGE = Color(255, 165, 0);

      it.fill(BLACK);

      // Boot splash screen
      if (!id(boot_complete)) {
        it.print(64, 40, id(large_font), GREEN, TextAlign::CENTER, "ED1");
        it.print(64, 70, id(pixel_font), WHITE, TextAlign::CENTER, "Booting...");
        return;
      }

      // Title (y=4)
      it.print(64, 4, id(large_font), GREEN, TextAlign::TOP_CENTER, "ED1");

      // IP Address (y=24)
      it.print(4, 24, id(icons_16), CYAN, "\U0000e870");
      it.print(22, 28, id(pixel_font), WHITE, id(wifi_ip).state.c_str());

      // WiFi signal (y=44)
      it.print(4, 44, id(icons_16), CYAN, "\U0000e63e");
      it.printf(22, 48, id(pixel_font), WHITE, "%.0f dBm", id(wifi_signal_sensor).state);

      // Light sensor (y=64)
      it.print(4, 64, id(icons_16), YELLOW, "\U0000e518");
      it.printf(22, 68, id(pixel_font), WHITE, "%.0f%%", id(light_sensor).state);

      // Temperature (y=84)
      it.print(4, 84, id(icons_16), ORANGE, "\U0000e1ff");
      it.printf(22, 88, id(pixel_font), WHITE, "%.0f C", id(cpu_temp).state);

      // Uptime (y=104)
      it.print(4, 104, id(icons_16), WHITE, "\U0000e8b5");
      int seconds = (int)id(uptime_sensor).state;
      int days = seconds / 86400;
      int hours = (seconds % 86400) / 3600;
      int mins = (seconds % 3600) / 60;
      if (days > 0) {
        it.printf(22, 108, id(pixel_font), WHITE, "%dd %dh %dm", days, hours, mins);
      } else if (hours > 0) {
        it.printf(22, 108, id(pixel_font), WHITE, "%dh %dm", hours, mins);
      } else {
        it.printf(22, 108, id(pixel_font), WHITE, "%dm %ds", mins, seconds % 60);
      }

# ==============================================================================
# 4. BUZZER (PWM OUTPUT)
# ==============================================================================
output:
  - platform: ledc
    pin: GPIO26
    id: buzzer_output

rtttl:
  output: buzzer_output
  id: buzzer_rtttl

button:
  - platform: template
    name: "ED1 Beep"
    on_press:
      - rtttl.play: 'beep:d=16,o=5,b=140:c'

  - platform: template
    name: "ED1 Alert"
    on_press:
      - rtttl.play: 'alert:d=8,o=5,b=180:c,c,c'

  - platform: template
    name: "ED1 Success"
    on_press:
      - rtttl.play: 'ok:d=8,o=5,b=160:c,e,g'

# ==============================================================================
# 5. IR RECEIVER (38kHz)
# ==============================================================================
remote_receiver:
  pin:
    number: GPIO35
    inverted: true
  dump: all
  on_nec:
    then:
      - lambda: |-
          ESP_LOGI("IR", "NEC: address=0x%04X, command=0x%04X", x.address, x.command);
  on_samsung:
    then:
      - lambda: |-
          ESP_LOGI("IR", "Samsung: data=0x%08X", x.data);

# ==============================================================================
# 6. BLUETOOTH PROXY
# ==============================================================================
esp32_ble_tracker:
  scan_parameters:
    interval: 1100ms
    window: 1100ms

bluetooth_proxy:
  active: true

# ==============================================================================
# 7. TOUCH BUTTONS
# ==============================================================================
esp32_touch:
  setup_mode: false

binary_sensor:
  - platform: esp32_touch
    id: btn_up
    name: "ED1 Button Up"
    pin: GPIO4
    threshold: 500
    on_press:
      - rtttl.play: 'beep:d=16,o=5,b=140:c'
      - logger.log: "Button Up PRESSED"

  - platform: esp32_touch
    id: btn_down
    name: "ED1 Button Down"
    pin: GPIO13
    threshold: 500
    on_press:
      - rtttl.play: 'beep:d=16,o=5,b=140:c'
      - logger.log: "Button Down PRESSED"

  - platform: esp32_touch
    id: btn_left
    name: "ED1 Button Left"
    pin: GPIO2
    threshold: 500
    on_press:
      - rtttl.play: 'beep:d=16,o=5,b=140:c'
      - logger.log: "Button Left PRESSED"

  - platform: esp32_touch
    id: btn_right
    name: "ED1 Button Right"
    pin: GPIO27
    threshold: 500
    on_press:
      - rtttl.play: 'beep:d=16,o=5,b=140:c'
      - logger.log: "Button Right PRESSED"

  - platform: esp32_touch
    id: btn_ok
    name: "ED1 Button OK"
    pin: GPIO15
    threshold: 500
    on_press:
      - rtttl.play: 'beep:d=16,o=5,b=140:c'
      - logger.log: "Button OK PRESSED"

  - platform: esp32_touch
    id: btn_x
    name: "ED1 Button X"
    pin: GPIO14
    threshold: 500
    on_press:
      - rtttl.play: 'beep:d=16,o=5,b=140:c'
      - logger.log: "Button X PRESSED"

# ==============================================================================
# 8. SENSORS
# ==============================================================================
sensor:
  - platform: wifi_signal
    name: "ED1 WiFi Signal"
    id: wifi_signal_sensor
    update_interval: 60s

  - platform: uptime
    name: "ED1 Uptime"
    id: uptime_sensor

  - platform: internal_temperature
    name: "ED1 CPU Temperature"
    id: cpu_temp

  - platform: adc
    pin: GPIO34
    name: "ED1 Light Level"
    id: light_sensor
    attenuation: 12db
    update_interval: 1s
    unit_of_measurement: "%"
    device_class: ""
    filters:
      - multiply: 30.3

text_sensor:
  - platform: wifi_info
    ip_address:
      name: "ED1 IP Address"
      id: wifi_ip
